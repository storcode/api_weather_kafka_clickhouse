# –ü–æ–≥–æ–¥–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –¥–∞–Ω–Ω—ã—Ö: Kafka + ClickHouse
*–ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Å–±–æ—Ä–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Apache Kafka –≤ —Ä–µ–∂–∏–º–µ KRaft –∏ ClickHouse.*

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
–ü–æ–≥–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Üí Python Producer ‚Üí Apache Kafka (3-–Ω–æ–¥–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä) ‚Üí ClickHouse
                                                ‚Üë
                                        Kafka UI (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)  

### üì¶ –°–æ—Å—Ç–∞–≤ —Å–µ—Ä–≤–∏—Å–æ–≤
#### 1. ClickHouse (clickhouse:latest) - –∫–æ–ª–æ–Ω–æ—á–Ω–∞—è –°–£–ë–î –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

- –ü–æ—Ä—Ç: 8122 (HTTP), 9000 (Native)

- –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ ./clickhouse_data

### 2. Apache Kafka Cluster (3 –Ω–æ–¥—ã –Ω–∞ KRaft) - –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π

- Kafka-1: –ø–æ—Ä—Ç 9091

- Kafka-2: –ø–æ—Ä—Ç 9092

- Kafka-3: –ø–æ—Ä—Ç 9093

- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å—é (replication factor=2, min ISR=2)

### 3. Kafka UI - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Kafka

- –î–æ—Å—Ç—É–ø: http://localhost:8190

### 4. Python –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å/–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

- –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º Supervisor

- –ò–º–µ–µ—Ç healthcheck –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
#### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Docker Engine 20.10+

- Docker Compose 2.0+

- –°–µ—Ç—å Docker weather_kafka_clickhouse

#### –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∏ Docker

- docker network create weather_kafka_clickhouse

#### –ó–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

- docker-compose up -d

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

- docker-compose ps

–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ running.

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
1. ClickHouse: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env.clickhouse

2. Kafka: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ docker-compose.yml

	- Cluster ID: r4zt_wrqTRuT7W4NJsB_GA

	- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã: –≤—Å–µ 3 –Ω–æ–¥—ã

#### –ü–æ—Ä—Ç-–º–∞–ø–ø–∏–Ω–≥
|–°–µ—Ä–≤–∏—Å | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–π –ø–æ—Ä—Å | –•–æ—Å—Ç–æ–≤–æ–π –ø–æ—Ä—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
|-------|-------------------|---------------|-----------
|ClickHouse | 8123 | 8122 | HTTP –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
|ClickHouse | 9000 | 9000 | Native –ø—Ä–æ—Ç–æ–∫–æ–ª
|Kafka-1 | 9092 | 9091 | –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
|Kafka-2 | 9092 | 9092 | –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
|Kafka-3 | 9092 | 9093 | –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
|Kafka UI | 8180 | 8190 | –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

## üìä –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Kafka
- –†–µ–∂–∏–º: KRaft (–±–µ–∑ Zookeeper)

- –ö–≤–æ—Ä—É–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤: 3 –Ω–æ–¥—ã

- –§–∞–∫—Ç–æ—Ä —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏: 2

- Min ISR: 2 (–≥–∞—Ä–∞–Ω—Ç–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏)

- –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–æ–≤: –≤–∫–ª—é—á–µ–Ω–æ

- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–∏—Ü–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 3

## üóÑÔ∏è –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

- ClickHouse: ./clickhouse_data/ (–º–∞–ø–ø–∏–Ω–≥ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)

- Kafka-1: volume kafka_1_data

- Kafka-2: volume kafka_2_data

- Kafka-3: volume kafka_3_data

## ü©∫ Healthcheck
Python –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π healthcheck, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π —Å—Ç–∞—Ç—É—Å Supervisor –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥.

## üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫

- ClickHouse, Kafka, Kafka UI: always

- Python –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: unless-stopped

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ .env.clickhouse          # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è ClickHouse
‚îú‚îÄ‚îÄ clickhouse_data/         # –î–∞–Ω–Ω—ã–µ ClickHouse
‚îú‚îÄ‚îÄ city_list.json          # –°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ cron_src/               # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ Python –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îî‚îÄ‚îÄ (–¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
#### –û—Å—Ç–∞–Ω–æ–≤–∫–∞
- docker-compose down

#### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º volumes

- docker-compose down -v

#### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

- docker-compose logs -f [service_name]

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
1. Kafka UI: http://localhost:8190

2. ClickHouse: http://localhost:8122/play

3. –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: docker-compose logs

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è
1. –°–µ—Ç—å weather_kafka_clickhouse –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞ –∑–∞—Ä–∞–Ω–µ–µ

2. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:

	- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é Kafka

	- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TLS/SSL –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

	- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ClickHouse

	- –ó–∞—â–∏—Ç–∏—Ç—å –ø–∞—Ä–æ–ª–µ–º Kafka UI